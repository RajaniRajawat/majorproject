<% layout('layouts/boilerplate') %>

<div class="container mt-4">

  <style>
  /* FILTER ROW FIX */
  #filters{
    display: flex;
    justify-content: flex-start;
    gap: 2rem;
    margin-top: 1rem;
  }

  .filter{
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    opacity: 0.7;
  }

  .filter:hover,
  .filter.selected{
    opacity: 1;
  }

  .filter i{
    font-size: 1.4rem;
  }

  .filter p{
    margin: 0;
    font-size: 0.85rem;
  }
</style>

<!-- FILTER ICONS -->
<div id="filters" class="mb-3">

  <div class="filter selected">
    <div><i class="fa-solid fa-fire"></i></div>
    <p>Trending</p>
  </div>

  <div class="filter">
    <div><i class="fa-solid fa-mountain"></i></div>
    <p>Mountains</p>
  </div>

  <div class="filter">
    <div><i class="fa-brands fa-fort-awesome"></i></div>
    <p>Castles</p>
  </div>

  <!-- LAST ME -->
  <div class="filter">
    <div><i class="fa-solid fa-bed"></i></div>
    <p>Rooms</p>
  </div>

  <div class="filter">
    <div><i class="fa-solid fa-mountain-city"></i></div>
    <p>Iconic Cities</p>
  </div>

</div>


  <!-- LISTINGS GRID -->
  <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4" id="listings-row">
    <% for (let listing of allListings) { %>
      <div class="col listing-card-wrapper">
        <a href="/listings/<%= listing._id %>" class="text-decoration-none text-dark">
          <div class="card h-100 listing-card shadow-sm"
               data-title="<%= listing.title.toLowerCase() %>"
               data-location="<%= listing.location ? listing.location.toLowerCase() : '' %>"
               data-category="<%
                 let cat = 'trending';
                 let t = listing.title.toLowerCase();
                 if(t.includes('mountain')) cat='mountains';
                 else if(t.includes('room')) cat='rooms';
                 else if(t.includes('castle')) cat='castles';
                 else if(t.includes('pool')) cat='amazing pools';
                 else if(t.includes('camp')) cat='camping';
                 else if(t.includes('farm')) cat='farms';
                 else if(t.includes('arctic') || t.includes('snow')) cat='arctic';
                 else if(t.includes('dome') || t.includes('igloo')) cat='domes';
               %><%= cat %>">

            <% if(listing.image && listing.image.url){ %>
            <img src="<%= listing.image.url %>" class="card-img-top index-img" alt="listing image" />
            <% } %>

            <div class="card-body">
              <h5 class="card-title mb-1"><%= listing.title %></h5>
              <p class="card-text text-muted mb-0">
                â‚¹ <%= listing.price.toLocaleString("en-IN") %> / night
              </p>
            </div>

          </div>
        </a>
      </div>
    <% } %>
  </div>

  <div class="empty-message text-center mt-4" id="empty-message" style="display:none;">
    Sorry! No listings available for this selection.
  </div>

</div>

<script>
  const listingsRow = document.getElementById("listings-row");
  const cards = document.querySelectorAll(".listing-card");
  const filters = document.querySelectorAll(".filter");
  const emptyMessage = document.getElementById("empty-message");

  // Get navbar search input
  const searchInput = document.querySelector(".navbar input[type='search']");

  function filterCards(categoryFilter, searchValue){
    listingsRow.innerHTML = '';
    let visibleCount = 0;

    cards.forEach(card => {
      const category = card.dataset.category || "";
      const location = card.dataset.location || "";

      const categoryMatch = (categoryFilter === "trending") || category.includes(categoryFilter);
      const searchMatch = !searchValue || location.includes(searchValue);

      if(categoryMatch && searchMatch){
        listingsRow.appendChild(card.parentElement);
        visibleCount++;
      }
    });

    if(visibleCount === 0){
      emptyMessage.style.display = "block";
      emptyMessage.innerText = `Sorry! No listings available for "${categoryFilter}" matching "${searchValue}"`;
    } else {
      emptyMessage.style.display = "none";
    }
  }

  // CATEGORY FILTER CLICK
  filters.forEach(filter => {
    filter.addEventListener("click", () => {
      filters.forEach(f => f.classList.remove("selected"));
      filter.classList.add("selected");

      const category = filter.innerText.toLowerCase().trim();
      const searchValue = searchInput ? searchInput.value.toLowerCase().trim() : "";
      filterCards(category, searchValue);
    });
  });

  // NAVBAR SEARCH INPUT
  if(searchInput){
    searchInput.addEventListener("input", () => {
      const value = searchInput.value.toLowerCase().trim();
      let selectedCategory = "trending";
      filters.forEach(f => {
        if(f.classList.contains("selected")) selectedCategory = f.innerText.toLowerCase().trim();
      });
      filterCards(selectedCategory, value);
    });

    // Prevent form submit reload
    searchInput.closest("form").addEventListener("submit", e => e.preventDefault());
  }
</script>
